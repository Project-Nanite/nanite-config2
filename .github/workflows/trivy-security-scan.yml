name: Trivy Security Scan

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]
  schedule:
    # Run daily at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch:

permissions:
  contents: write
  security-events: write

jobs:
  trivy-scan:
    name: Trivy Vulnerability Scanner
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Create trivy-outputs directory
        run: mkdir -p trivy-outputs

      - name: Run Trivy vulnerability scanner (JSON format)
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'json'
          output: 'trivy-outputs/trivy-results.json'
          severity: 'CRITICAL,HIGH,MEDIUM,LOW'
          ignore-unfixed: false

      - name: Run Trivy vulnerability scanner (Table format)
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'table'
          output: 'trivy-outputs/trivy-results.txt'
          severity: 'CRITICAL,HIGH,MEDIUM,LOW'
          ignore-unfixed: false

      - name: Run Trivy vulnerability scanner (SARIF format for GitHub)
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-outputs/trivy-results.sarif'
          severity: 'CRITICAL,HIGH,MEDIUM,LOW'

      - name: Upload Trivy results to GitHub Security tab
        uses: github/codeql-action/upload-sarif@v4
        if: always()
        with:
          sarif_file: 'trivy-outputs/trivy-results.sarif'

      - name: Install dependencies for PDF generation
        run: |
          sudo apt-get update
          sudo apt-get install -y wkhtmltopdf python3-pip
          pip3 install jinja2

      - name: Generate HTML report from JSON
        run: |
          cat > generate_report.py << 'EOF'
          import json
          import sys
          from datetime import datetime

          # Read JSON results
          with open('trivy-outputs/trivy-results.json', 'r') as f:
              data = json.load(f)

          # Generate HTML
          html = """
          <!DOCTYPE html>
          <html>
          <head>
              <meta charset="UTF-8">
              <title>Trivy Security Scan Report</title>
              <style>
                  body {
                      font-family: Arial, sans-serif;
                      margin: 20px;
                      background-color: #f5f5f5;
                  }
                  .header {
                      background-color: #2c3e50;
                      color: white;
                      padding: 20px;
                      border-radius: 5px;
                      margin-bottom: 20px;
                  }
                  .summary {
                      background-color: white;
                      padding: 15px;
                      border-radius: 5px;
                      margin-bottom: 20px;
                      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                  }
                  .vulnerability {
                      background-color: white;
                      padding: 15px;
                      margin-bottom: 15px;
                      border-radius: 5px;
                      border-left: 4px solid #3498db;
                      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                  }
                  .critical { border-left-color: #e74c3c; }
                  .high { border-left-color: #e67e22; }
                  .medium { border-left-color: #f39c12; }
                  .low { border-left-color: #3498db; }
                  .severity {
                      display: inline-block;
                      padding: 5px 10px;
                      border-radius: 3px;
                      color: white;
                      font-weight: bold;
                      font-size: 12px;
                  }
                  .severity.CRITICAL { background-color: #e74c3c; }
                  .severity.HIGH { background-color: #e67e22; }
                  .severity.MEDIUM { background-color: #f39c12; }
                  .severity.LOW { background-color: #3498db; }
                  .vuln-id {
                      font-weight: bold;
                      color: #2c3e50;
                      font-size: 16px;
                  }
                  .package-name {
                      color: #7f8c8d;
                      font-style: italic;
                  }
                  table {
                      width: 100%;
                      border-collapse: collapse;
                      margin-top: 10px;
                  }
                  th, td {
                      padding: 8px;
                      text-align: left;
                      border-bottom: 1px solid #ddd;
                  }
                  th {
                      background-color: #34495e;
                      color: white;
                  }
                  .no-vulnerabilities {
                      background-color: #2ecc71;
                      color: white;
                      padding: 20px;
                      border-radius: 5px;
                      text-align: center;
                      font-size: 18px;
                  }
              </style>
          </head>
          <body>
              <div class="header">
                  <h1>ðŸ”’ Trivy Security Scan Report</h1>
                  <p>Generated: """ + datetime.now().strftime("%Y-%m-%d %H:%M:%S UTC") + """</p>
              </div>
          """

          # Count vulnerabilities by severity
          severity_counts = {"CRITICAL": 0, "HIGH": 0, "MEDIUM": 0, "LOW": 0}
          total_vulns = 0

          results = data.get('Results', [])
          
          for result in results:
              vulns = result.get('Vulnerabilities', [])
              if vulns:
                  for vuln in vulns:
                      severity = vuln.get('Severity', 'UNKNOWN')
                      if severity in severity_counts:
                          severity_counts[severity] += 1
                      total_vulns += 1

          # Summary section
          html += """
              <div class="summary">
                  <h2>Summary</h2>
                  <table>
                      <tr>
                          <th>Severity</th>
                          <th>Count</th>
                      </tr>
                      <tr>
                          <td><span class="severity CRITICAL">CRITICAL</span></td>
                          <td>""" + str(severity_counts['CRITICAL']) + """</td>
                      </tr>
                      <tr>
                          <td><span class="severity HIGH">HIGH</span></td>
                          <td>""" + str(severity_counts['HIGH']) + """</td>
                      </tr>
                      <tr>
                          <td><span class="severity MEDIUM">MEDIUM</span></td>
                          <td>""" + str(severity_counts['MEDIUM']) + """</td>
                      </tr>
                      <tr>
                          <td><span class="severity LOW">LOW</span></td>
                          <td>""" + str(severity_counts['LOW']) + """</td>
                      </tr>
                      <tr>
                          <th>Total</th>
                          <th>""" + str(total_vulns) + """</th>
                      </tr>
                  </table>
              </div>
          """

          if total_vulns == 0:
              html += '<div class="no-vulnerabilities">âœ… No vulnerabilities found!</div>'
          else:
              html += '<h2>Detailed Findings</h2>'
              
              for result in results:
                  target = result.get('Target', 'Unknown')
                  vulns = result.get('Vulnerabilities', [])
                  
                  if vulns:
                      html += f'<h3>Target: {target}</h3>'
                      
                      for vuln in vulns:
                          vuln_id = vuln.get('VulnerabilityID', 'N/A')
                          pkg_name = vuln.get('PkgName', 'N/A')
                          installed_version = vuln.get('InstalledVersion', 'N/A')
                          fixed_version = vuln.get('FixedVersion', 'Not fixed yet')
                          severity = vuln.get('Severity', 'UNKNOWN')
                          title = vuln.get('Title', 'No title available')
                          description = vuln.get('Description', 'No description available')
                          
                          html += f"""
                          <div class="vulnerability {severity.lower()}">
                              <div>
                                  <span class="vuln-id">{vuln_id}</span>
                                  <span class="severity {severity}">{severity}</span>
                              </div>
                              <p class="package-name">Package: {pkg_name} ({installed_version})</p>
                              <p><strong>Fixed Version:</strong> {fixed_version}</p>
                              <p><strong>Title:</strong> {title}</p>
                              <p><strong>Description:</strong> {description[:500]}{'...' if len(description) > 500 else ''}</p>
                          </div>
                          """

          html += """
          </body>
          </html>
          """

          # Write HTML file
          with open('trivy-outputs/trivy-report.html', 'w') as f:
              f.write(html)

          print("HTML report generated successfully!")
          EOF

          python3 generate_report.py

      - name: Convert HTML to PDF
        run: |
          wkhtmltopdf --enable-local-file-access \
            --page-size A4 \
            --margin-top 10mm \
            --margin-bottom 10mm \
            --margin-left 10mm \
            --margin-right 10mm \
            trivy-outputs/trivy-report.html \
            trivy-outputs/trivy-report.pdf
          
          echo "PDF report generated at trivy-outputs/trivy-report.pdf"
          ls -lh trivy-outputs/

      - name: Upload Trivy scan results as artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: trivy-scan-results
          path: trivy-outputs/
          retention-days: 30

      - name: Commit and push results to repository
        if: github.event_name != 'pull_request'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add trivy-outputs/
          git diff --staged --quiet || git commit -m "chore: Update Trivy security scan results [skip ci]"
          git push
        continue-on-error: true

      - name: Check for critical vulnerabilities
        run: |
          CRITICAL_COUNT=$(jq '[.Results[]?.Vulnerabilities[]? | select(.Severity=="CRITICAL")] | length' trivy-outputs/trivy-results.json)
          HIGH_COUNT=$(jq '[.Results[]?.Vulnerabilities[]? | select(.Severity=="HIGH")] | length' trivy-outputs/trivy-results.json)
          
          echo "Critical vulnerabilities: $CRITICAL_COUNT"
          echo "High vulnerabilities: $HIGH_COUNT"
          
          if [ "$CRITICAL_COUNT" -gt 0 ]; then
            echo "::warning::Found $CRITICAL_COUNT critical vulnerabilities!"
          fi
          
          if [ "$HIGH_COUNT" -gt 0 ]; then
            echo "::warning::Found $HIGH_COUNT high vulnerabilities!"
          fi
          
          # Uncomment the following lines to fail the build on critical vulnerabilities
          # if [ "$CRITICAL_COUNT" -gt 0 ]; then
          #   echo "::error::Build failed due to critical vulnerabilities!"
          #   exit 1
          # fi

