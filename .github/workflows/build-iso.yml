name: Build Debian ISO

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:
    inputs:
      debian_version:
        description: 'Debian version to build'
        required: false
        default: 'bookworm'
        type: choice
        options:
          - bookworm
          - bullseye
          - trixie
          - sid

permissions:
  contents: write

jobs:
  build-iso:
    name: Build ISO on Debian
    runs-on: ubuntu-latest
    container:
      image: debian:bookworm
      options: --privileged
    
    steps:
      - name: Install Git and basic dependencies
        run: |
          apt-get update
          apt-get install -y git ca-certificates

      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install live-build and dependencies
        run: |
          apt-get update
          apt-get install -y \
            live-build \
            debootstrap \
            curl \
            wget \
            xorriso \
            syslinux \
            syslinux-common \
            isolinux \
            squashfs-tools \
            genisoimage \
            dosfstools \
            mtools \
            rsync \
            apt-utils \
            gnupg \
            sudo

      - name: Display system information
        run: |
          echo "==================================="
          echo "System Information"
          echo "==================================="
          cat /etc/os-release
          echo ""
          echo "Kernel: $(uname -r)"
          echo "Architecture: $(uname -m)"
          echo "Live-build version: $(lb --version)"
          echo "Debootstrap version: $(debootstrap --version)"
          echo ""
          df -h
          echo ""

      - name: Clean previous builds
        run: |
          if [ -d "auto" ]; then
            lb clean --purge || true
          fi
          rm -f *.iso *.img *.zsync || true

      - name: Run lb config
        run: |
          echo "==================================="
          echo "Running lb config"
          echo "==================================="
          
          # Run lb config from the build script or directly
          if [ -f "build.sh" ]; then
            chmod +x build.sh
          fi
          
          # Run lb config
          lb config
          
          echo ""
          echo "Configuration completed successfully!"
          echo ""

      - name: Display configuration
        run: |
          echo "==================================="
          echo "Live-build Configuration"
          echo "==================================="
          if [ -f "auto/config" ]; then
            echo "auto/config exists"
            head -50 auto/config
          fi
          echo ""
          if [ -d "config" ]; then
            echo "Config directory structure:"
            ls -la config/
          fi
          echo ""

      - name: Run lb build
        run: |
          echo "==================================="
          echo "Starting ISO Build Process"
          echo "==================================="
          echo "Build started at: $(date)"
          echo ""
          
          # Start time tracking
          START_TIME=$(date +%s)
          
          # Run lb build
          lb build 2>&1 | tee build.log
          
          # End time tracking
          END_TIME=$(date +%s)
          DURATION=$((END_TIME - START_TIME))
          MINUTES=$((DURATION / 60))
          SECONDS=$((DURATION % 60))
          
          echo ""
          echo "==================================="
          echo "Build completed at: $(date)"
          echo "Total build time: ${MINUTES}m ${SECONDS}s"
          echo "==================================="
          echo ""

      - name: List generated files
        run: |
          echo "==================================="
          echo "Generated ISO Files"
          echo "==================================="
          ls -lh *.iso *.img *.zsync 2>/dev/null || echo "No ISO/IMG files found in root"
          echo ""
          
          # Check in common output directories
          if [ -d "live-image-amd64" ]; then
            echo "Files in live-image-amd64:"
            ls -lh live-image-amd64/
          fi
          
          echo ""
          echo "Disk space usage:"
          df -h
          echo ""

      - name: Rename and organize ISO files
        run: |
          # Find the generated ISO file
          ISO_FILE=$(find . -maxdepth 1 -name "*.iso" -type f | head -1)
          
          if [ -n "$ISO_FILE" ]; then
            # Get file size
            ISO_SIZE=$(du -h "$ISO_FILE" | cut -f1)
            
            # Create a descriptive name with timestamp
            TIMESTAMP=$(date +%Y%m%d-%H%M%S)
            NEW_NAME="nanite-debian-${TIMESTAMP}.iso"
            
            # Rename the ISO
            mv "$ISO_FILE" "$NEW_NAME"
            
            # Generate checksums
            sha256sum "$NEW_NAME" > "${NEW_NAME}.sha256"
            md5sum "$NEW_NAME" > "${NEW_NAME}.md5"
            
            echo "ISO renamed to: $NEW_NAME"
            echo "ISO size: $ISO_SIZE"
            echo ""
            echo "Checksums generated:"
            cat "${NEW_NAME}.sha256"
            cat "${NEW_NAME}.md5"
            
            # Store ISO name for later steps
            echo "ISO_FILENAME=$NEW_NAME" >> $GITHUB_ENV
            echo "ISO_SIZE=$ISO_SIZE" >> $GITHUB_ENV
          else
            echo "Error: No ISO file found!"
            exit 1
          fi

      - name: Upload ISO as artifact
        uses: actions/upload-artifact@v4
        with:
          name: debian-iso-build
          path: |
            *.iso
            *.sha256
            *.md5
            build.log
          retention-days: 7
          compression-level: 0

      - name: Create release info
        run: |
          cat > RELEASE_INFO.md << EOF
          # ðŸš€ Nanite Debian ISO Build
          
          **Build Date:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          **ISO Filename:** ${{ env.ISO_FILENAME }}
          **ISO Size:** ${{ env.ISO_SIZE }}
          **Debian Base:** bookworm
          **Architecture:** amd64
          
          ## ðŸ“¥ Download
          
          The ISO file is available as a GitHub Actions artifact. You can download it from the Actions tab.
          
          ## âœ… Checksums
          
          ### SHA256
          \`\`\`
          $(cat ${{ env.ISO_FILENAME }}.sha256)
          \`\`\`
          
          ### MD5
          \`\`\`
          $(cat ${{ env.ISO_FILENAME }}.md5)
          \`\`\`
          
          ## ðŸ”§ Build Information
          
          - **Workflow:** ${{ github.workflow }}
          - **Run Number:** ${{ github.run_number }}
          - **Commit:** ${{ github.sha }}
          - **Branch:** ${{ github.ref_name }}
          
          ## ðŸ“ How to Use
          
          1. Download the ISO file from the artifacts
          2. Verify the checksum
          3. Write to USB or burn to DVD
          4. Boot and enjoy!
          
          EOF
          
          cat RELEASE_INFO.md

      - name: Upload release info
        uses: actions/upload-artifact@v4
        with:
          name: release-info
          path: RELEASE_INFO.md
          retention-days: 7

      - name: Create GitHub Release (on tag push)
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v1
        with:
          files: |
            *.iso
            *.sha256
            *.md5
            RELEASE_INFO.md
          body_path: RELEASE_INFO.md
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Build summary
        if: always()
        run: |
          echo "==================================="
          echo "ðŸ“Š Build Summary"
          echo "==================================="
          echo ""
          echo "âœ… Build Status: Success"
          echo "ðŸ“¦ ISO File: ${{ env.ISO_FILENAME }}"
          echo "ðŸ’¾ Size: ${{ env.ISO_SIZE }}"
          echo "ðŸ• Workflow Run: ${{ github.run_number }}"
          echo "ðŸ”— Commit: ${{ github.sha }}"
          echo ""
          echo "==================================="
          echo "ðŸ“¥ Download Instructions"
          echo "==================================="
          echo ""
          echo "1. Go to the Actions tab in GitHub"
          echo "2. Click on this workflow run"
          echo "3. Scroll down to 'Artifacts'"
          echo "4. Download 'debian-iso-build'"
          echo ""
          echo "==================================="

      - name: Comment on PR with build info
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const releaseInfo = fs.readFileSync('RELEASE_INFO.md', 'utf8');
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: releaseInfo
            });

